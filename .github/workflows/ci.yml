# =============================================================================
# CI — Text Replacement Extension
# =============================================================================
# Runs on every push and pull request to verify:
#   1. The build script succeeds for both Chromium and Firefox targets.
#   2. Both manifests are valid JSON with the correct manifest_version.
#   3. All source files referenced in the manifests actually exist.
#   4. No external URLs are loaded (privacy/security check).
#   5. The Content Security Policy does not include 'unsafe-inline' for scripts.
# =============================================================================

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    name: Build & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run build script
        run: |
          chmod +x build.sh
          ./build.sh
          echo "Build completed successfully."

      - name: Validate Chromium manifest
        run: |
          echo "Validating Chromium manifest..."
          # Check it's valid JSON
          python3 -c "import json; json.load(open('dist/chromium/manifest.json'))"
          # Check manifest_version is 3
          VERSION=$(python3 -c "import json; print(json.load(open('dist/chromium/manifest.json'))['manifest_version'])")
          if [ "$VERSION" != "3" ]; then
            echo "ERROR: Chromium manifest_version is $VERSION, expected 3"
            exit 1
          fi
          echo "Chromium manifest is valid (MV$VERSION)."

      - name: Validate Firefox manifest
        run: |
          echo "Validating Firefox manifest..."
          # Check it's valid JSON
          python3 -c "import json; json.load(open('dist/firefox/manifest.json'))"
          # Check manifest_version is 3
          VERSION=$(python3 -c "import json; print(json.load(open('dist/firefox/manifest.json'))['manifest_version'])")
          if [ "$VERSION" != "3" ]; then
            echo "ERROR: Firefox manifest_version is $VERSION, expected 3"
            exit 1
          fi
          # Check gecko settings exist
          python3 -c "
import json
m = json.load(open('dist/firefox/manifest.json'))
assert 'browser_specific_settings' in m, 'Missing browser_specific_settings'
assert 'gecko' in m['browser_specific_settings'], 'Missing gecko settings'
print('Firefox manifest is valid (MV' + str(m['manifest_version']) + ', gecko ID: ' + m['browser_specific_settings']['gecko']['id'] + ').')
"

      - name: Verify all referenced files exist
        run: |
          echo "Checking that all files referenced in manifests exist..."
          ERRORS=0
          for target in chromium firefox; do
            DIR="dist/$target"

            # Check all JS files referenced in manifest
            for file in $(python3 -c "
import json
m = json.load(open('$DIR/manifest.json'))
# Background scripts
bg = m.get('background', {})
for f in bg.get('scripts', []):
    print(f)
if 'service_worker' in bg:
    print(bg['service_worker'])
# Content scripts
for cs in m.get('content_scripts', []):
    for f in cs.get('js', []):
        print(f)
"); do
              if [ ! -f "$DIR/$file" ]; then
                echo "ERROR: $target manifest references '$file' but it doesn't exist in $DIR/"
                ERRORS=$((ERRORS + 1))
              fi
            done

            # Check icon files
            for file in $(python3 -c "
import json
m = json.load(open('$DIR/manifest.json'))
for size, path in m.get('icons', {}).items():
    print(path)
"); do
              if [ ! -f "$DIR/$file" ]; then
                echo "ERROR: $target manifest references icon '$file' but it doesn't exist"
                ERRORS=$((ERRORS + 1))
              fi
            done

            echo "  $target: all referenced files exist."
          done

          if [ $ERRORS -gt 0 ]; then
            echo "FAILED: $ERRORS missing file(s) detected."
            exit 1
          fi

      - name: Security — no external URLs in source
        run: |
          echo "Checking for external URL references in source files..."
          # Look for http:// or https:// URLs in JS/HTML/CSS files (excluding comments about what we DON'T do)
          FOUND=$(grep -rn 'https\?://[a-zA-Z]' src/ --include='*.js' --include='*.html' --include='*.css' \
            | grep -v '// ' | grep -v ' \* ' | grep -v '<!-- ' | grep -v '/\*' || true)
          if [ -n "$FOUND" ]; then
            echo "WARNING: External URLs found in source files (review for safety):"
            echo "$FOUND"
            # Don't fail — URLs in comments are OK, but flag for review
          else
            echo "No external URLs found in source code."
          fi

      - name: Security — verify CSP does not allow unsafe-inline for scripts
        run: |
          echo "Checking Content Security Policy..."
          for target in chromium firefox; do
            CSP=$(python3 -c "
import json
m = json.load(open('dist/$target/manifest.json'))
csp = m.get('content_security_policy', {})
if isinstance(csp, dict):
    print(csp.get('extension_pages', ''))
else:
    print(csp)
")
            # Check that script-src does NOT contain unsafe-inline
            if echo "$CSP" | grep -q "script-src.*unsafe-inline"; then
              echo "ERROR: $target CSP allows 'unsafe-inline' for scripts!"
              exit 1
            fi
            # Check that style-src does NOT contain unsafe-inline
            if echo "$CSP" | grep -q "style-src.*unsafe-inline"; then
              echo "ERROR: $target CSP allows 'unsafe-inline' for styles!"
              exit 1
            fi
            echo "  $target CSP is strict: $CSP"
          done
          echo "CSP checks passed."

      - name: Verify builds are identical except manifests
        run: |
          echo "Verifying source files are identical across builds..."
          ERRORS=0
          for file in background.js content.js manage.js manage.html manage.css; do
            if ! diff -q "dist/chromium/$file" "dist/firefox/$file" > /dev/null 2>&1; then
              echo "ERROR: $file differs between chromium and firefox builds!"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ $ERRORS -gt 0 ]; then
            echo "FAILED: Source files should be identical across builds."
            exit 1
          fi
          echo "All shared source files are identical across builds."
