# =============================================================================
# CI - Text Replacement Extension
# =============================================================================
# Runs on every push and pull request to verify:
#   1. The build script succeeds for both Chromium and Firefox targets.
#   2. Both manifests are valid JSON with the correct manifest_version.
#   3. All source files referenced in the manifests actually exist.
#   4. No external URLs are loaded (privacy/security check).
#   5. The Content Security Policy does not include 'unsafe-inline'.
#   6. Source files are identical across browser builds.
# =============================================================================

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    name: Build & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run build script
        run: |
          chmod +x build.sh
          ./build.sh
          echo "Build completed successfully."

      - name: Validate manifests
        run: |
          echo "Validating manifests..."
          python3 << 'PYEOF'
          import json, sys

          errors = []

          # --- Chromium ---
          with open("dist/chromium/manifest.json") as f:
              cm = json.load(f)
          if cm["manifest_version"] != 3:
              errors.append(f"Chromium manifest_version is {cm['manifest_version']}, expected 3")
          else:
              print(f"  Chromium: valid (MV{cm['manifest_version']})")

          # --- Firefox ---
          with open("dist/firefox/manifest.json") as f:
              fm = json.load(f)
          if fm["manifest_version"] != 3:
              errors.append(f"Firefox manifest_version is {fm['manifest_version']}, expected 3")
          if "browser_specific_settings" not in fm:
              errors.append("Firefox manifest missing browser_specific_settings")
          elif "gecko" not in fm["browser_specific_settings"]:
              errors.append("Firefox manifest missing gecko settings")
          else:
              gecko_id = fm["browser_specific_settings"]["gecko"]["id"]
              print(f"  Firefox:  valid (MV{fm['manifest_version']}, gecko ID: {gecko_id})")

          if errors:
              for e in errors:
                  print(f"ERROR: {e}")
              sys.exit(1)

          print("Manifest validation passed.")
          PYEOF

      - name: Verify all referenced files exist
        run: |
          echo "Checking referenced files..."
          python3 << 'PYEOF'
          import json, os, sys

          errors = []
          for target in ["chromium", "firefox"]:
              d = f"dist/{target}"
              with open(f"{d}/manifest.json") as f:
                  m = json.load(f)

              # Background scripts
              bg = m.get("background", {})
              for f_name in bg.get("scripts", []):
                  if not os.path.isfile(f"{d}/{f_name}"):
                      errors.append(f"{target}: missing background script {f_name}")
              sw = bg.get("service_worker")
              if sw and not os.path.isfile(f"{d}/{sw}"):
                  errors.append(f"{target}: missing service worker {sw}")

              # Content scripts
              for cs in m.get("content_scripts", []):
                  for f_name in cs.get("js", []):
                      if not os.path.isfile(f"{d}/{f_name}"):
                          errors.append(f"{target}: missing content script {f_name}")

              # Icons
              for size, path in m.get("icons", {}).items():
                  if not os.path.isfile(f"{d}/{path}"):
                      errors.append(f"{target}: missing icon {path}")

              print(f"  {target}: all referenced files exist.")

          if errors:
              for e in errors:
                  print(f"ERROR: {e}")
              sys.exit(1)

          print("File reference check passed.")
          PYEOF

      - name: Security - no external URLs in source
        run: |
          echo "Checking for external URL references in source files..."
          FOUND=$(grep -rn 'https\?://[a-zA-Z]' src/ --include='*.js' --include='*.html' --include='*.css' \
            | grep -v '// ' | grep -v ' \* ' | grep -v '<!-- ' | grep -v '/\*' || true)
          if [ -n "$FOUND" ]; then
            echo "WARNING: External URLs found in source files (review for safety):"
            echo "$FOUND"
          else
            echo "No external URLs found in source code."
          fi

      - name: Security - verify strict CSP
        run: |
          echo "Checking Content Security Policy..."
          python3 << 'PYEOF'
          import json, sys

          errors = []
          for target in ["chromium", "firefox"]:
              with open(f"dist/{target}/manifest.json") as f:
                  m = json.load(f)
              csp_obj = m.get("content_security_policy", {})
              if isinstance(csp_obj, dict):
                  csp = csp_obj.get("extension_pages", "")
              else:
                  csp = str(csp_obj)

              if "unsafe-inline" in csp and "script-src" in csp:
                  errors.append(f"{target} CSP allows unsafe-inline for scripts!")
              if "unsafe-inline" in csp and "style-src" in csp:
                  errors.append(f"{target} CSP allows unsafe-inline for styles!")
              print(f"  {target} CSP: {csp}")

          if errors:
              for e in errors:
                  print(f"ERROR: {e}")
              sys.exit(1)

          print("CSP checks passed.")
          PYEOF

      - name: Verify builds are identical except manifests
        run: |
          echo "Verifying source files are identical across builds..."
          ERRORS=0
          for file in background.js content.js manage.js manage.html manage.css; do
            if ! diff -q "dist/chromium/$file" "dist/firefox/$file" > /dev/null 2>&1; then
              echo "ERROR: $file differs between chromium and firefox builds!"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ $ERRORS -gt 0 ]; then
            echo "FAILED: Source files should be identical across builds."
            exit 1
          fi
          echo "All shared source files are identical across builds."
